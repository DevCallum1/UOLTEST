version: '3.9'

services:
  web:
    image: "resgridllc/resgridwebcore:0.5.13"
    ports:
      - "5151:80"
    env_file:
      - resgrid.env
    depends_on:
      - api
      - events
      - db
      - redis
      - rabbitmq
      - worker
    environment:
      WAIT_HOSTS: db:1433,redis:6379,rabbitmq:15672,api:80
      WAIT_BEFORE: 90

  api:
    image: "resgridllc/resgridwebservices:0.5.13"
    ports:
      - "5152:80"
    env_file:
      - resgrid.env
    depends_on:
      - events
      - db
      - redis
      - rabbitmq
      - worker
    environment:
      WAIT_HOSTS: db:1433,redis:6379,rabbitmq:15672,events:80
      WAIT_BEFORE: 90

  events:
    image: "resgridllc/resgridwebevents:0.5.13"
    ports:
      - "5153:80"
    env_file:
      - resgrid.env
    depends_on:
      - db
      - redis
      - rabbitmq
    environment:
      WAIT_HOSTS: db:1433,redis:6379,rabbitmq:15672
      WAIT_BEFORE: 90

  worker:
    image: "resgridllc/resgridworkersconsole:0.5.13"
    env_file:
      - resgrid.env
    depends_on:
      - db
      - redis
      - rabbitmq
    environment:
      WAIT_HOSTS: db:1433,redis:6379,rabbitmq:15672

  db:
    image: "mcr.microsoft.com/mssql/server"
    ports:
      - "5157:1433"
    build:
      context: .
      dockerfile: db/Dockerfile
    volumes: 
        - ./docker-data/sql/data:/var/opt/sqlserver/data
        - ./docker-data/sql/log:/var/opt/sqlserver/log
        - ./docker-data/sql/backup:/var/opt/sqlserver/backup

  redis:
    image: "redis:alpine"
    command: redis-server --save 60 1 --loglevel warning
    ports:
     - "5158:6379"

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=resgrid
      - RABBITMQ_DEFAULT_PASS=Resgrid321!
    ports:
      - "5160:15672"
      - "5159:5672"

  elk:
    image: sebp/elk
    ports:
      - "5163:5601"
      - "5164:9200"
      - "5165:5044"

  mailserver:
    image: docker.io/mailserver/docker-mailserver:latest
    container_name: mailserver
    # If the FQDN for your mail-server is only two labels (eg: example.com),
    # you can assign this entirely to `hostname` and remove `domainname`.
    hostname: rgmail
    domainname: yourcompany.com
    env_file: mailserver.env
    # More information about the mail-server ports:
    # https://docker-mailserver.github.io/docker-mailserver/edge/config/security/understanding-the-ports/
    # To avoid conflicts with yaml base-60 float, DO NOT remove the quotation marks.
    ports:
      - "25:25"    # SMTP  (explicit TLS => STARTTLS)
      - "143:143"  # IMAP4 (explicit TLS => STARTTLS)
      - "465:465"  # ESMTP (implicit TLS)
      - "587:587"  # ESMTP (explicit TLS => STARTTLS)
      - "993:993"  # IMAP4 (implicit TLS)
    volumes:
      - ./docker-data/dms/mail-data/:/var/mail/
      - ./docker-data/dms/mail-state/:/var/mail-state/
      - ./docker-data/dms/mail-logs/:/var/log/mail/
      - ./docker-data/dms/config/:/tmp/docker-mailserver/
      - /etc/localtime:/etc/localtime:ro
    restart: always
    stop_grace_period: 1m
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
